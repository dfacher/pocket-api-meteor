
/*Meteor.publish("userData", function () {
  return Meteor.users.find({_id: this.userId},
                           {fields: {'services': 1}});
});*/



// Account handling

Accounts.onCreateUser(function(options, user){
    if (options.profile)
	user.profile = options.profile;
    user.pocket = {isCode: 0, accessCode: ''};
    
    return user;
});

 Accounts.addAutopublishFields({
    forLoggedInUser: ['pocket'],
  });


// Methods

Meteor.methods({
    getAccessToken : function(){
	var id =  Meteor.userId();
        var accessCode = {uid: id, accessToken: null};
        if(PocketAuths.findOne({uid: id})){
            accessCode = PocketAuths.findOne({uid: id}).fetch();
        }
        
        return accessCode;
    },

    
    authPocket: function() {
	console.log('Pocket auth started');
	var authUrl = 'https://getpocket.com/v3/oauth/request';
	var consumer_key = '17580-7de40cb3f846864f61048d5d';
	var redirect_uri = 'http://ec2-54-201-47-37.us-west-2.compute.amazonaws.com:3000/';

	var response = HTTP.call('POST', authUrl, {params: {'consumer_key': consumer_key, 'redirect_uri': redirect_uri}});
	var reqToken = '';
	
	if(response.statusCode==200){
	    reqToken = response.content;
	    reqToken = reqToken.replace('code=', '');
	    
	}
	else throw new Meteor.Error(response.statusCode);
	
	return reqToken;
  }
    
});
